@page "/Progress"

@rendermode InteractiveServer

@if (isLoaded is false)
{
    <Loading />
}
else
{
    <header class="main-header">
        @if (isDescription is false || alreadyDescribed is true)
        {
        <button @onclick="PreviousQuestion">
            <img src="/back.svg" />
        </button>
        }

        <h4 class="header-title">بخش @SectionNumber</h4>
    </header>
    <div class="question-wrapper">
        @if (isDescription is true && alreadyDescribed is false)
        {
            <QuestionnaireDescriptionCard QuestionnaireId="questionnaire!.Id" OnContinue="HandleContinue" />
        }
        else
        {
            <QuestionCard QuestionId="QuestionId" ParticipantId="participant!.Id" OnAnswered="HandleAnswer" />
        }
    </div>
    <footer>
        <ProgressBar ResponsesCount="@ResponsesCount" />
    </footer>
}

@code {
    private Participant? participant;

    private List<Questionnaire>? Questionnaires;
    private List<Question>? Questions;

    private Guid? QuestionId;
    private Question? question;
    private Questionnaire? questionnaire;

    private int? SectionNumber;
    private int ResponsesCount = 0;

    private bool ShouldDisplayDescription = false;

    private bool isLoaded = false;
    private bool isDescription = false;
    private bool alreadyDescribed = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        using var context = DbContextFactory.CreateDbContext();

        if (firstRender)
        {
            var participantId = await getParticipantId();
            if (participantId is null)
            {
                NavigationManager.NavigateTo("/", true);
                return;
            }

            participant ??= await context.Participants
                .FirstOrDefaultAsync(p => p.Id.ToString() == participantId);
            if (participant is null)
            {
                await localStorage.ClearAsync();
                NavigationManager.NavigateTo("/", true);
                return;
            }

            firstRender = false;
        }

        // Load Responses List
        var responsesList = await getParticipantResponses();

        // Finish if Complete Then Redirect to Thanks
        var isCompleted = await checkIfCompleted();
        if (isCompleted)
        {
            await FinalizeQuestionnaire();
            return;
        }

        // Continue if it is not Complete
        QuestionId = await getNextQuestionId(responsesList!);
        if (QuestionId is null)
        {
            await FinalizeQuestionnaire();
            return;
        }

        // Display First Question After Last Response
        isDescription = await checkIfIsDescription(QuestionId);
        if (isDescription is true)
        {
            questionnaire = await getQuestionnaire(QuestionId);
        }

        isLoaded = true;

        StateHasChanged();
    }

    private async Task<string?> getParticipantId()
    {
        var participantId = await localStorage.GetItemAsync<string>("participantId");
        return participantId;
    }

    private async Task<List<Response>?> getParticipantResponses()
    {
        using var context = DbContextFactory.CreateDbContext();
        var responses = await context.Responses
            .Include(m => m.Question)
                .ThenInclude(m => m.Questionnaire)
            .Where(m => m.ParticipantId == participant!.Id)
            .OrderBy(m => m.Question.Position)
            .OrderBy(m => m.Question.Questionnaire.Priority)
            .ToListAsync();
        ResponsesCount = responses.Count();
        return responses;
    }

    private async Task<bool> checkIfCompleted()
    {
        using var context = DbContextFactory.CreateDbContext();
        var questionsCount = await context.Questions
            .CountAsync();
        return ResponsesCount >= questionsCount;
    }

    private async Task<Guid?> getNextQuestionId(List<Response>? responses)
    {
        using var context = DbContextFactory.CreateDbContext();
        var lastResponse = responses!.Count == 0 ? null : responses!.Last();
        var questionnairePriority = lastResponse is not null
            ? lastResponse.Question.Questionnaire.Priority
            : 1;
        var questionPosition = lastResponse is not null
            ? lastResponse.Question.Position
            : 0;
        var nextQuestion = await context.Questions
            .Include(m => m.Questionnaire)
            .Where(m => m.Questionnaire.Priority == questionnairePriority)
            .FirstOrDefaultAsync(m => m.Position == questionPosition + 1);
        if (nextQuestion is not null)
        {
            SectionNumber = nextQuestion.Questionnaire.Priority;
            return nextQuestion.Id;
        }
        var questionnairesCount = await context.Questionnaires.CountAsync();
        if (questionnairePriority >= questionnairesCount)
        {
            return null;
        }
        questionnairePriority += 1;
        nextQuestion = await context.Questions
            .Include(m => m.Questionnaire)
            .Where(m => m.Questionnaire.Priority == questionnairePriority)
            .FirstOrDefaultAsync(m => m.Position == 1);
        if (nextQuestion is not null)
        {
            SectionNumber = nextQuestion.Questionnaire.Priority;
            return nextQuestion.Id;
        }
        return null;
    }

    private async Task<bool> checkIfIsDescription(Guid? questionId)
    {
        using var context = DbContextFactory.CreateDbContext();
        var question = await context.Questions
            .FirstOrDefaultAsync(m => m.Id == questionId);
        var position = question!.Position;
        return position == 1;
    }

    private async Task<Questionnaire?> getQuestionnaire(Guid? questionId)
    {
        using var context = DbContextFactory.CreateDbContext();
        var question = await context.Questions
            .Include(m => m.Questionnaire)
            .FirstOrDefaultAsync(m => m.Id == questionId);
        return question!.Questionnaire;
    }

    private async Task FinalizeQuestionnaire()
    {
        await localStorage.ClearAsync();
        NavigationManager.NavigateTo("/Thanks", true);
        return;
    }




    private async Task PreviousQuestion()
    {
        var currentQuestion = question!.Position;
        if (currentQuestion > 1)
        {
            question = Questions!.FirstOrDefault(q => q.Position == currentQuestion - 1);
        }
        else
        {
            var currentQuestionnaire = questionnaire!.Priority;
            questionnaire = Questionnaires!
                .FirstOrDefault(q => q.Priority == currentQuestionnaire - 1);

            if (questionnaire is not null)
            {
                using var context = DbContextFactory.CreateDbContext();
                Questions = await context.Questions
                    .Include(q => q.Scale)
                        .ThenInclude(s => s.Options)
                    .Where(q => q.QuestionnaireId == questionnaire.Id)
                    .OrderBy(q => q.Position)
                    .ToListAsync();

                question = Questions.LastOrDefault();
            }
        }

        StateHasChanged();
    }

    private async Task HandleAnswer()
    {
        alreadyDescribed = false;
        isLoaded = false;
        StateHasChanged();
    }

    private void HandleContinue()
    {
        alreadyDescribed = true;
        StateHasChanged();
    }
}
